{% extends 'userdashboard/base.html' %}
{% load static %}

{% block title %}Profile - GeoSurvey{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="profile-header-content">
            <div class="header-profile-picture">
                <img src="{% if user.avatar and user.avatar.url %}{{ user.avatar.url }}{% else %}data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iNjAiIGZpbGw9IiM2QjcyOEIiLz4KPGNpcmNsZSBjeD0iNjAiIGN5PSI0NSIgcj0iMjAiIGZpbGw9IiNEOUQ5RDkiLz4KPHBhdGggZD0iTTIwIDEwNUMyMCA5NS4wNTc2IDI4LjA1NzYgODcgMzggODdIODJDNzEuOTQyNCA4NyA2NCA5NS4wNTc2IDY0IDEwNUg2NEM2NCA5NS4wNTc2IDU1Ljk0MjQgODcgNDUgODdIMzhDMjguMDU3NiA4NyAyMCA5NS4wNTc2IDIwIDEwNVoiIGZpbGw9IiNEOUQ5RDkiLz4KPC9zdmc+Cg=={% endif %}" 
                     alt="Profile Picture" class="header-avatar" id="header-profile-preview">
                <div class="header-picture-overlay">
                    <label for="avatar-upload" class="header-upload-btn">
                        <i class="fas fa-camera"></i>
                    </label>
                </div>
            </div>
            <div class="profile-info">
                <h1 class="profile-name" title="{{ user.full_name|default:user.email }}">{{ user.full_name|default:user.email }}</h1>
                <p class="profile-email" title="{{ user.email }}">{{ user.email }}</p>
                <div class="profile-stats">
                    <span class="stat-item">
                        <i class="fas fa-file"></i>
                        {{ total_files|default:"0" }} Files
                    </span>
                    <span class="stat-item">
                        <i class="fas fa-map"></i>
                        {{ total_surveys|default:"0" }} Surveys
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Profile Completion Status -->
        <div class="profile-completion-section">
            <div class="completion-header">
                <h3>Profile Completion</h3>
                {% if is_verified %}
                    <div class="verification-badge">
                        <i class="fas fa-check-circle"></i>
                        Verified Profile
                    </div>
                {% endif %}
            </div>
            <div class="completion-progress">
                <div class="progress-bar">
                    <div class="progress-fill" style="width: {{ profile_completion }}%"></div>
                </div>
                <span class="progress-text">{{ profile_completion }}% Complete</span>
            </div>
            <div class="completion-breakdown">
                <div class="breakdown-item">
                    <span class="breakdown-label">Personal Info:</span>
                    <span class="breakdown-value">{{ personal_completion }}%</span>
                </div>
                <div class="breakdown-item">
                    <span class="breakdown-label">Social Links:</span>
                    <span class="breakdown-value">{{ social_completion }}%</span>
                </div>
            </div>
            {% if profile_completion < 100 %}
                <div class="completion-tip">
                    <i class="fas fa-lightbulb"></i>
                    {% if personal_completion < 100 %}
                        Complete your personal information to reach 80%
                    {% elif social_completion < 100 %}
                        Add your social links to reach 100% and get verified
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>

    <form method="post" enctype="multipart/form-data" class="profile-form">
        {% csrf_token %}
        
        <!-- Hidden input for avatar upload -->
        <input type="file" id="avatar-upload" name="avatar" accept="image/*" style="display: none;">

        <!-- Personal Information -->
        <div class="profile-section">
            <div class="section-header">
                <h2><i class="fas fa-user"></i> Personal Information</h2>
                <button type="submit" name="update_profile" class="save-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
            <div class="profile-grid">
                <div class="form-group">
                    <label for="full_name">Full Name</label>
                    <input type="text" id="full_name" name="full_name" value="{{ user.full_name|default:'' }}" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="phone_number">Phone Number</label>
                    <input type="tel" id="phone_number" name="phone_number" value="{{ user.phone_number|default:'' }}" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label for="date_of_birth">Date of Birth</label>
                    <input type="date" id="date_of_birth" name="date_of_birth" value="{{ user.date_of_birth|date:'Y-m-d'|default:'' }}">
                </div>
                <div class="form-group">
                    <label for="address">Address</label>
                    <input type="text" id="address" name="address" value="{{ user.address|default:'' }}" placeholder="Enter your address">
                </div>
                <div class="form-group">
                    <label for="city">City</label>
                    <input type="text" id="city" name="city" value="{{ user.city|default:'' }}" placeholder="Enter your city">
                </div>
                <div class="form-group">
                    <label for="state">State/Province</label>
                    <input type="text" id="state" name="state" value="{{ user.state|default:'' }}" placeholder="Enter your state">
                </div>
                <div class="form-group">
                    <label for="country">Country</label>
                    <input type="text" id="country" name="country" value="{{ user.country|default:'' }}" placeholder="Enter your country">
                </div>
                <div class="form-group">
                    <label for="postal_code">Postal Code</label>
                    <input type="text" id="postal_code" name="postal_code" value="{{ user.postal_code|default:'' }}" placeholder="Enter your postal code">
                </div>
            </div>
        </div>

        <!-- Social Links -->
        <div class="profile-section">
            <div class="section-header">
                <h2><i class="fab fa-linkedin"></i> Social Links</h2>
                <button type="submit" name="update_social" class="save-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
            <div class="profile-grid">
                <div class="form-group">
                    <label for="github">GitHub Profile</label>
                    <input type="url" id="github" name="github" value="{{ user.github|default:'' }}" placeholder="https://github.com/yourusername">
                </div>
                <div class="form-group">
                    <label for="linkedin">LinkedIn Profile</label>
                    <input type="url" id="linkedin" name="linkedin" value="{{ user.linkedin|default:'' }}" placeholder="https://linkedin.com/in/yourusername">
                </div>
                <div class="form-group">
                    <label for="facebook">Facebook Profile</label>
                    <input type="url" id="facebook" name="facebook" value="{{ user.facebook|default:'' }}" placeholder="https://facebook.com/yourusername">
                </div>
            </div>
        </div>

        <!-- Password Management -->
        <div class="profile-section">
            <div class="section-header">
                <h2><i class="fas fa-lock"></i> Password Management</h2>
                <button type="submit" name="change_password" class="save-btn">
                    <i class="fas fa-key"></i> Change Password
                </button>
            </div>
            <div class="profile-grid">
                <div class="form-group">
                    <label for="current_password">Current Password</label>
                    <input type="password" id="current_password" name="current_password" placeholder="Enter your current password">
                </div>
                <div class="form-group">
                    <label for="new_password">New Password</label>
                    <input type="password" id="new_password" name="new_password" placeholder="Enter your new password">
                </div>
                <div class="form-group">
                    <label for="confirm_password">Confirm New Password</label>
                    <input type="password" id="confirm_password" name="confirm_password" placeholder="Confirm your new password">
                </div>
            </div>
        </div>

        <!-- Account Settings -->
        <div class="profile-section">
            <div class="section-header">
                <h2><i class="fas fa-cog"></i> Account Settings</h2>
                <button type="submit" name="update_settings" class="save-btn">
                    <i class="fas fa-save"></i> Save Changes
                </button>
            </div>
            <div class="settings-grid">
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Email Notifications</h3>
                        <p>Receive email updates about your account and surveys</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="email_notifications" {% if user.email_notifications %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Two-Factor Authentication</h3>
                        <p>Add an extra layer of security to your account</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="two_factor_enabled" {% if user.two_factor_enabled %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <div class="setting-info">
                        <h3>Public Profile</h3>
                        <p>Allow others to view your profile information</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" name="public_profile" {% if user.public_profile %}checked{% endif %}>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <!-- Danger Zone -->
        <div class="profile-section danger-zone">
            <div class="section-header">
                <h2><i class="fas fa-exclamation-triangle"></i> Danger Zone</h2>
            </div>
            <div class="danger-content">
                <div class="danger-warning">
                    <h3>Delete Account</h3>
                    <p>This action cannot be undone. This will permanently delete your account and remove all your data from our servers.</p>
                    <button type="submit" name="delete_account" class="delete-btn" onclick="return confirm('Are you sure you want to delete your account? This action cannot be undone.')">
                        <i class="fas fa-trash"></i> Delete Account
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
/* Profile Container */
.profile-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    background: #f8fafc;
    min-height: 100vh;
}

/* Profile Header */
.profile-header {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    border-radius: 20px;
    padding: 30px;
    margin-bottom: 30px;
    color: white;
    box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
}

.profile-header-content {
    display: flex;
    align-items: center;
    gap: 25px;
    margin-bottom: 25px;
}

/* Header Profile Picture */
.header-profile-picture {
    position: relative;
    flex-shrink: 0;
}

.header-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    border: 4px solid #fbbf24;
    box-shadow: 0 4px 20px rgba(251, 191, 36, 0.3);
    object-fit: cover;
    object-position: center;
    transition: transform 0.3s ease;
    cursor: pointer;
}

.header-avatar:hover {
    transform: scale(1.05);
}

.header-picture-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.6);
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 50%;
}

.header-profile-picture:hover .header-picture-overlay {
    opacity: 1;
}

.header-upload-btn {
    color: white;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 8px;
    border-radius: 50%;
    background: rgba(59, 130, 246, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.2);
    transition: background 0.3s ease;
}

.header-upload-btn:hover {
    background: rgba(59, 130, 246, 1);
}

/* Profile Info */
.profile-info {
    flex: 1;
}

.profile-name {
    font-size: 2rem;
    font-weight: 700;
    margin: 0 0 5px 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 400px;
}

.profile-email {
    font-size: 1.1rem;
    margin: 0 0 15px 0;
    opacity: 0.9;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 400px;
}

.profile-stats {
    display: flex;
    gap: 20px;
}

.stat-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.9rem;
    opacity: 0.9;
}

/* Profile Completion Section */
.profile-completion-section {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 20px;
    backdrop-filter: blur(10px);
}

.completion-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.completion-header h3 {
    margin: 0;
    font-size: 1.2rem;
    font-weight: 600;
}

.verification-badge {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 600;
    border: 1px solid rgba(34, 197, 94, 0.3);
}

.verification-badge i {
    font-size: 1rem;
}

.completion-progress {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 15px;
}

.progress-bar {
    flex: 1;
    height: 8px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #fbbf24 0%, #f59e0b 100%);
    border-radius: 4px;
    transition: width 0.5s ease;
}

.progress-text {
    font-size: 0.9rem;
    font-weight: 600;
    min-width: 80px;
}

.completion-breakdown {
    display: flex;
    gap: 20px;
    margin-bottom: 10px;
}

.breakdown-item {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
}

.breakdown-label {
    opacity: 0.8;
}

.breakdown-value {
    font-weight: 600;
    color: #fbbf24;
}

.completion-tip {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 0.85rem;
    opacity: 0.8;
    color: #fbbf24;
}

/* Profile Sections */
.profile-section {
    background: white;
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    border: 1px solid #e5e7eb;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f3f4f6;
}

.section-header h2 {
    margin: 0;
    font-size: 1.4rem;
    font-weight: 600;
    color: #1f2937;
    display: flex;
    align-items: center;
    gap: 10px;
}

.section-header h2 i {
    color: #3b82f6;
}

.save-btn {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 8px;
}

.save-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
}

/* Form Grid */
.profile-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    font-weight: 600;
    color: #374151;
    margin-bottom: 8px;
    font-size: 0.9rem;
}

.form-group input {
    padding: 12px 15px;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
    min-width: 0;
}

.form-group input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-group input::placeholder {
    color: #9ca3af;
}

/* Settings Grid */
.settings-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: #f9fafb;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
}

.setting-info h3 {
    margin: 0 0 5px 0;
    font-size: 1rem;
    font-weight: 600;
    color: #1f2937;
}

.setting-info p {
    margin: 0;
    font-size: 0.9rem;
    color: #6b7280;
}

/* Toggle Switch */
.toggle-switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #3b82f6;
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

/* Danger Zone */
.danger-zone {
    border: 2px solid #ef4444;
    background: #fef2f2;
}

.danger-zone .section-header h2 {
    color: #dc2626;
}

.danger-zone .section-header h2 i {
    color: #ef4444;
}

.danger-content {
    text-align: center;
}

.danger-warning h3 {
    color: #dc2626;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.danger-warning p {
    color: #6b7280;
    margin-bottom: 20px;
    font-size: 0.95rem;
    line-height: 1.5;
}

.delete-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    padding: 12px 25px;
    border-radius: 8px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.delete-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .profile-container {
        padding: 15px;
    }
    
    .profile-header {
        padding: 20px;
    }
    
    .profile-header-content {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }
    
    .header-avatar {
        width: 80px;
        height: 80px;
    }
    
    .profile-name {
        font-size: 1.5rem;
        max-width: 100%;
    }
    
    .profile-email {
        max-width: 100%;
    }
    
    .profile-stats {
        justify-content: center;
    }
    
    .completion-header {
        flex-direction: column;
        gap: 10px;
        text-align: center;
    }
    
    .completion-breakdown {
        flex-direction: column;
        gap: 10px;
    }
    
    .section-header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
    
    .profile-grid {
        grid-template-columns: 1fr;
    }
    
    .setting-item {
        flex-direction: column;
        gap: 15px;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .profile-header {
        padding: 15px;
    }
    
    .header-avatar {
        width: 70px;
        height: 70px;
    }
    
    .profile-name {
        font-size: 1.3rem;
    }
    
    .profile-email {
        font-size: 1rem;
    }
    
    .profile-section {
        padding: 20px;
    }
    
    .form-group input {
        padding: 10px 12px;
        font-size: 0.9rem;
    }
    
    .save-btn {
        padding: 8px 15px;
        font-size: 0.85rem;
    }
    
    .delete-btn {
        padding: 10px 20px;
        font-size: 0.9rem;
    }
}
</style>

<script>
// Avatar upload functionality
document.getElementById('avatar-upload').addEventListener('change', function(e) {
    if (e.target.files && e.target.files[0]) {
        const file = e.target.files[0];
        
        // Preview the image
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('header-profile-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);
        
        // Upload the file
        const formData = new FormData();
        formData.append('avatar', file);
        formData.append('update_profile', 'true');
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Show loading state
        const uploadBtn = document.querySelector('.header-upload-btn');
        const originalText = uploadBtn.innerHTML;
        uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        fetch(window.location.href, {
            method: 'POST',
            body: formData
        }).then(response => {
            if (response.ok) {
                // Show success message
                uploadBtn.innerHTML = '<i class="fas fa-check"></i>';
                setTimeout(() => {
                    uploadBtn.innerHTML = originalText;
                }, 2000);
            } else {
                // Show error message
                uploadBtn.innerHTML = '<i class="fas fa-times"></i>';
                setTimeout(() => {
                    uploadBtn.innerHTML = originalText;
                }, 2000);
            }
        }).catch(error => {
            console.error('Upload error:', error);
            uploadBtn.innerHTML = '<i class="fas fa-times"></i>';
            setTimeout(() => {
                uploadBtn.innerHTML = originalText;
            }, 2000);
        });
    }
});

// Form validation
document.querySelectorAll('input[type="url"]').forEach(input => {
    input.addEventListener('blur', function() {
        const url = this.value.trim();
        if (url && !isValidUrl(url)) {
            this.style.borderColor = '#ef4444';
            this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
        } else {
            this.style.borderColor = '#e5e7eb';
            this.style.boxShadow = 'none';
        }
    });
});

function isValidUrl(string) {
    try {
        new URL(string);
        return true;
    } catch (_) {
        return false;
    }
}

// Password confirmation validation
document.getElementById('confirm_password').addEventListener('input', function() {
    const newPassword = document.getElementById('new_password').value;
    const confirmPassword = this.value;
    
    if (confirmPassword && newPassword !== confirmPassword) {
        this.style.borderColor = '#ef4444';
        this.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
    } else {
        this.style.borderColor = '#e5e7eb';
        this.style.boxShadow = 'none';
    }
});
</script>
{% endblock %} 