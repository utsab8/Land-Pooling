{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoSurveyPro - Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'admindashboard/dashboard.css' %}" rel="stylesheet">
    <style>
        .settings-card {
            transition: all 0.3s ease;
            border: none;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .settings-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .setting-item {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s ease;
        }
        
        .setting-item:hover {
            background-color: #f8fafc;
        }
        
        .setting-item:last-child {
            border-bottom: none;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #2563eb;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .color-picker {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .backup-schedule {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .security-settings {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 1px solid #2563eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 d-md-block bg-dark sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'admin_dashboard' %}">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'admin-users' %}">
                                <i class="fas fa-users"></i> Users
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'admin-survey' %}">
                                <i class="fas fa-file-alt"></i> Surveys
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="{% url 'admin-system' %}">
                                <i class="fas fa-cogs"></i> System
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="{% url 'admin-settings' %}">
                                <i class="fas fa-sliders-h me-2"></i>
                                Settings
                            </a>
                        </li>
                        <li class="nav-item mt-4">
                            <a class="nav-link text-danger" href="{% url 'logout' %}">
                                <i class="fas fa-sign-out-alt me-2"></i>
                                Logout
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                    <h1 class="h2">System Settings</h1>
                    <div class="btn-toolbar mb-2 mb-md-0">
                        <div class="btn-group me-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="resetSettings()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button type="button" class="btn btn-sm btn-primary" onclick="saveAllSettings()">
                                <i class="fas fa-save"></i> Save All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Settings Navigation -->
                <ul class="nav nav-tabs mb-4" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="general-tab" data-bs-toggle="tab" data-bs-target="#general" type="button" role="tab">
                            <i class="fas fa-cog me-2"></i>General
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="tab" data-bs-target="#security" type="button" role="tab">
                            <i class="fas fa-shield-alt me-2"></i>Security
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="backup-tab" data-bs-toggle="tab" data-bs-target="#backup" type="button" role="tab">
                            <i class="fas fa-database me-2"></i>Backup
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                            <i class="fas fa-bell me-2"></i>Notifications
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="appearance-tab" data-bs-toggle="tab" data-bs-target="#appearance" type="button" role="tab">
                            <i class="fas fa-palette me-2"></i>Appearance
                        </button>
                    </li>
                </ul>

                <!-- Settings Content -->
                <div class="tab-content" id="settingsContent">
                    <!-- General Settings -->
                    <div class="tab-pane fade show active" id="general" role="tabpanel">
                        <div class="card settings-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-cog me-2"></i>General Settings</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Site Name</h6>
                                            <p class="text-muted mb-0">The name of your application</p>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="siteName" value="GeoSurveyPro">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Site Description</h6>
                                            <p class="text-muted mb-0">Brief description of your application</p>
                                        </div>
                                        <div class="col-md-4">
                                            <textarea class="form-control" id="siteDescription" rows="2">Advanced Geospatial Survey Management System</textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Time Zone</h6>
                                            <p class="text-muted mb-0">Default timezone for the application</p>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="timezone">
                                                <option value="UTC">UTC</option>
                                                <option value="EST">Eastern Time</option>
                                                <option value="PST">Pacific Time</option>
                                                <option value="GMT">GMT</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Maintenance Mode</h6>
                                            <p class="text-muted mb-0">Enable maintenance mode to restrict access</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="maintenanceMode">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Debug Mode</h6>
                                            <p class="text-muted mb-0">Enable debug mode for development</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="debugMode">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="security-settings">
                            <h5><i class="fas fa-shield-alt me-2"></i>Security Configuration</h5>
                            <p class="text-muted">Configure security settings for your application</p>
                        </div>
                        
                        <div class="card settings-card">
                            <div class="card-body p-0">
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Two-Factor Authentication</h6>
                                            <p class="text-muted mb-0">Require 2FA for all users</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="twoFactorAuth">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Session Timeout (minutes)</h6>
                                            <p class="text-muted mb-0">Auto-logout after inactivity</p>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="sessionTimeout" value="30" min="5" max="480">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Password Complexity</h6>
                                            <p class="text-muted mb-0">Minimum password requirements</p>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="passwordComplexity">
                                                <option value="low">Low (6 characters)</option>
                                                <option value="medium" selected>Medium (8 characters, mixed)</option>
                                                <option value="high">High (10 characters, special chars)</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">IP Whitelist</h6>
                                            <p class="text-muted mb-0">Restrict access to specific IP addresses</p>
                                        </div>
                                        <div class="col-md-4">
                                            <textarea class="form-control" id="ipWhitelist" rows="3" placeholder="Enter IP addresses (one per line)"></textarea>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Rate Limiting</h6>
                                            <p class="text-muted mb-0">Limit API requests per minute</p>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="rateLimit" value="100" min="10" max="1000">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Backup Settings -->
                    <div class="tab-pane fade" id="backup" role="tabpanel">
                        <div class="backup-schedule">
                            <h5><i class="fas fa-database me-2"></i>Backup Configuration</h5>
                            <p class="text-muted">Configure automatic backup settings</p>
                        </div>
                        
                        <div class="card settings-card">
                            <div class="card-body p-0">
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Auto Backup</h6>
                                            <p class="text-muted mb-0">Enable automatic database backups</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="autoBackup" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Backup Frequency</h6>
                                            <p class="text-muted mb-0">How often to create backups</p>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="backupFrequency">
                                                <option value="daily">Daily</option>
                                                <option value="weekly" selected>Weekly</option>
                                                <option value="monthly">Monthly</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Retention Period (days)</h6>
                                            <p class="text-muted mb-0">How long to keep backups</p>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="number" class="form-control" id="backupRetention" value="30" min="1" max="365">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Backup Location</h6>
                                            <p class="text-muted mb-0">Where to store backups</p>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="backupLocation" value="/backups/">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Compress Backups</h6>
                                            <p class="text-muted mb-0">Compress backup files to save space</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="compressBackups" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification Settings -->
                    <div class="tab-pane fade" id="notifications" role="tabpanel">
                        <div class="card settings-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-bell me-2"></i>Notification Settings</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Email Notifications</h6>
                                            <p class="text-muted mb-0">Send notifications via email</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="emailNotifications" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">System Alerts</h6>
                                            <p class="text-muted mb-0">Receive system error alerts</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="systemAlerts" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">User Activity</h6>
                                            <p class="text-muted mb-0">Notify about user activities</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="userActivityNotifications">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Admin Email</h6>
                                            <p class="text-muted mb-0">Email address for admin notifications</p>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="email" class="form-control" id="adminEmail" value="admin@geosurveypro.com">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Appearance Settings -->
                    <div class="tab-pane fade" id="appearance" role="tabpanel">
                        <div class="card settings-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-palette me-2"></i>Appearance Settings</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Theme</h6>
                                            <p class="text-muted mb-0">Choose application theme</p>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="theme">
                                                <option value="light" selected>Light</option>
                                                <option value="dark">Dark</option>
                                                <option value="auto">Auto</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Primary Color</h6>
                                            <p class="text-muted mb-0">Main application color</p>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="color" class="color-picker" id="primaryColor" value="#2563eb">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Sidebar Position</h6>
                                            <p class="text-muted mb-0">Position of the navigation sidebar</p>
                                        </div>
                                        <div class="col-md-4">
                                            <select class="form-select" id="sidebarPosition">
                                                <option value="left" selected>Left</option>
                                                <option value="right">Right</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="setting-item">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h6 class="mb-1">Compact Mode</h6>
                                            <p class="text-muted mb-0">Use compact layout for better space usage</p>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="toggle-switch">
                                                <input type="checkbox" id="compactMode">
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script>
        // Initialize settings page
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Auto-save on change
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', function() {
                    saveSetting(this.id, this.value, this.type === 'checkbox' ? this.checked : this.value);
                });
            });
        }

        function loadSettings() {
            fetch('{% url "admin_api_settings" %}')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateSettings(data.settings);
                    }
                })
                .catch(error => console.error('Error loading settings:', error));
        }

        function populateSettings(settings) {
            // Populate form fields with loaded settings
            Object.keys(settings).forEach(key => {
                const element = document.getElementById(key);
                if (element) {
                    if (element.type === 'checkbox') {
                        element.checked = settings[key];
                    } else {
                        element.value = settings[key];
                    }
                }
            });
        }

        function saveSetting(key, value, actualValue) {
            fetch('{% url "admin_api_settings" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    key: key,
                    value: actualValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(`Setting "${key}" saved`, 'success');
                } else {
                    showToast(`Error saving "${key}": ${data.message}`, 'error');
                }
            })
            .catch(error => {
                showToast(`Error saving "${key}": ${error.message}`, 'error');
            });
        }

        function saveAllSettings() {
            const settings = {};
            const inputs = document.querySelectorAll('input, select, textarea');
            
            inputs.forEach(input => {
                if (input.type === 'checkbox') {
                    settings[input.id] = input.checked;
                } else {
                    settings[input.id] = input.value;
                }
            });

            fetch('{% url "admin_api_settings" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(settings)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('All settings saved successfully', 'success');
                } else {
                    showToast('Error saving settings: ' + data.message, 'error');
                }
            })
            .catch(error => {
                showToast('Error saving settings: ' + error.message, 'error');
            });
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to default values?')) {
                fetch('{% url "admin_api_settings" %}', {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('Settings reset to defaults', 'success');
                        loadSettings();
                    } else {
                        showToast('Error resetting settings: ' + data.message, 'error');
                    }
                })
                .catch(error => {
                    showToast('Error resetting settings: ' + error.message, 'error');
                });
            }
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                </div>
            `;
            
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                document.body.appendChild(container);
            }
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
    </script>
</body>
</html>
